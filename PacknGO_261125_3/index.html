<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Pack & Go ‚Äî bKash Wallet Edition v5r8</title>
<meta name="theme-color" content="#E2136E" />

<style>
/* --- BASE STYLES --- */
:root{
  --bkash:#E2136E; --bkash-dark:#B60F58; --ink:#12131A; --muted:#5E6270;
  --bg:#fff8fb; --card:#ffffff; --good:#16a34a; --bad:#ef4444; --gold:#f59e0b;
  --ring:#ffe4f2; --shadow:0 12px 34px rgba(0,0,0,.08);
  --input-border: #e5e7eb;
}
*{box-sizing:border-box}
/* SCROLLABILITY FIX: Allow scrolling if content is too tall */
html,body{height:100%; overflow-x: hidden; } 
body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);}

/* --- LAYOUT FIXES FOR VERTICAL PLAYER --- */
.container{
  max-width:1100px; margin:0 auto; padding:14px; 
  /* Removed height:100% and added min-height to allow content to grow and be scrollable */
  min-height: 100vh;
  display: flex; flex-direction: column; 
}
.main-game-content {
  flex: 1; display: flex; flex-direction: column; height: 100%; overflow: visible; /* Allow overflow if the container is short */
}
.view {
  flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 100%;
}

/* --- LANDING PAGE --- */
#view-landing.view {
  background: url('assets/background.png') no-repeat center center fixed;
  background-size: cover;
  position: absolute; inset: 0; z-index: 10;
  display: block; 
}

/* Play button - Fixed Positioning - Font is now sleek sans-serif */
#playButton {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 18%; /* Fixed distance from bottom */
  background-color: #FFD400;
  color: #000;
  border: 5px solid #000;
  border-radius: 8px;
  font-family: inherit; /* Use clean system font */
  font-weight: 900; /* Made bolder to stand out */
  font-size: 1.5rem;
  padding: 22px 64px;
  cursor: pointer;
  box-shadow: 0 6px #9A7A00;
  text-transform: uppercase;
  transition: all 0.1s ease;
  z-index: 20;
}
#playButton:hover { transform: translateX(-50%) translateY(-2px); }
#playButton:active { transform: translateX(-50%) translateY(2px); box-shadow: 0 2px #9A7A00; }

.fullscreen-toggle{
  position: absolute; top: 20px; right: 20px;
  background: rgba(255, 255, 255, 0.9); color: var(--bkash); border: 2px solid var(--bkash);
  box-shadow: none; font-size: 0.9rem; padding: 10px 16px; border-radius: 8px; font-weight: 700;
  cursor: pointer; z-index: 20;
}

/* Landing Buttons Wrapper (Leaderboard button) - MOVED HIGHER */
.landing-actions {
    position: absolute;
    bottom: 8%; /* Adjusted position */
    width: 100%;
    display: flex;
    justify-content: center;
    z-index: 15;
}
#btnShowLeaderboard {
    background: rgba(255, 255, 255, 0.9);
    color: var(--bkash);
    border: 2px solid var(--bkash);
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.95rem;
    box-shadow: 0 4px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
  #playButton { bottom: 15%; font-size: 1.2rem; padding: 18px 50px; }
  .landing-actions { bottom: 5%; }
}

/* --- GAME LOGIC STYLES --- */
header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:6px 0 12px; flex-shrink: 0;}
.brand{display:flex;align-items:center;gap:10px;}
.kite{width:32px;height:32px;border-radius:9px;background:conic-gradient(from 45deg, var(--bkash) 0 25%, #ff9aca 0 50%, var(--bkash) 0 75%, #ffb6d9 0);transform:rotate(45deg);box-shadow:var(--shadow);}
.title{font-weight:900;letter-spacing:.2px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
button{cursor:pointer;border:0;padding:10px 14px;border-radius:12px;background:var(--bkash);color:#fff;font-weight:900;box-shadow:0 4px 0 var(--bkash-dark);transition:transform .08s ease,box-shadow .08s ease,opacity .2s;}
button:hover{transform:translateY(-1px);box-shadow:0 6px 0 var(--bkash-dark);}
button:active{transform:translateY(1px);box-shadow:0 2px 0 var(--bkash-dark);}
.btn-ghost{background:#fff;color:var(--bkash);box-shadow:inset 0 0 0 2px var(--bkash);}
.btn-plain{background:#f3f4f6;color:#111827;box-shadow:none;}
.btn-soft{background:#ffd7ea;color:#7a0e40;box-shadow:none;}

.card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px;}

/* Inputs (Used for Name Input) - Inherits sleek system font */
input[type="number"], input[type="text"]{
  padding:16px 16px;
  border-radius:16px;border:2px solid var(--input-border);font-size:1.06rem;font-weight:900;outline:none;
  background:#fff; transition:border .15s ease, box-shadow .15s ease; min-height:58px;
}
input[type="number"]:focus, input[type="text"]:focus{ border-color:#feb3d5; box-shadow:0 0 0 4px #ffe4f2; }
label{font-size:.95rem;font-weight:800;color:#0f172a;display:block;margin-bottom:6px;}
#playerName{width:100%;}

/* Mode bar */
.modebar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;}
.toggle{display:inline-flex;background:#fff;border-radius:14px;overflow:hidden;border:2px solid #ffe0ef;box-shadow:none;opacity:.9}
.toggle button{background:transparent;color:#111827;box-shadow:none;padding:6px 10px;font-weight:800;font-size:.92rem}
.toggle button.active{background:var(--bkash);color:#fff;}
.help{font-size:.92rem;color:#4b5563;}
.note{background:#fff7fb;border:2px solid var(--ring);padding:8px 10px;border-radius:10px;font-weight:700;color:#7a0e40;}

/* Destinations */
.destinations-wrap{ flex-grow:1; overflow-y:auto; padding-bottom:12px; margin-top: 10px; }
.destinations{ display:grid; grid-template-columns:1fr; gap:12px; }
@media (min-width: 600px) { .destinations{ grid-template-columns: 1fr 1fr; } }
.dest-card{position:relative;overflow:hidden;border:2px solid #fff;border-radius:16px;display:flex;flex-direction:column;min-height:220px;background:#fff;transition:transform .12s ease;cursor:pointer;}
.dest-card:hover{transform:translateY(-3px)}
.dest-card .scene-wrap{display:flex;align-items:center;justify-content:center;padding:8px;background:#fff;pointer-events:none;}
.scene{width:100%;height:120px;display:block;border-radius:12px;border:1px solid #f2f2f6;object-fit:contain;background:#fff;pointer-events:none;}
.dest-card h3{margin:8px 0 4px;text-align:left;}
.dest-card p{margin:0;color:var(--muted);font-size:.92rem;}
.dest-card .grow{flex:1;padding:0 8px 6px 8px;pointer-events:none;}
.dest-card .footer{display:flex;justify-content:flex-end;align-items:flex-end;padding:0 8px 10px 8px;pointer-events:none;}
.chip{display:inline-flex;align-items:center;gap:6px;font-size:.8rem;padding:6px 10px;background:#fdf2f8;color:#831843;border-radius:999px;border:1px solid #ffd7ea;}

/* HUD */
.stats{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.stat{background:#fff;padding:10px 14px;border-radius:14px;font-weight:900;box-shadow:var(--shadow);border:2px solid var(--ring);}
.stat small{display:block;color:#a11a57;font-weight:800;letter-spacing:.2px;}
#timer{font-size:1.6rem; min-width: 140px; font-variant-numeric: tabular-nums;} 
#packedCount{font-size:1.3rem;} #needCount{opacity:.8;}

/* Game Items */
.items{
  display:grid; grid-template-columns:repeat(auto-fill, minmax(90px, 1fr)); 
  gap:10px; overflow-y:auto; padding: 6px 0; min-height: 150px;
}
.item{background:#fff;min-height:110px;border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:10px;user-select:none;border:2px solid transparent;transition:transform .12s ease,box-shadow .12s ease,border-color .1s ease,background .2s ease;}
.item .icon{width:52px;height:52px;transition:transform .12s ease;}
.item .label{font-weight:800;font-size:.76rem;text-align:center;opacity:.72;}
.item.correct{border-color:var(--good);background:linear-gradient(180deg,#ecfdf5,#fff);}
.item.wrong{border-color:var(--bad);animation:shake .22s linear;background:linear-gradient(180deg,#fff5f5,#fff);}
@keyframes shake{25%{transform:translateX(-2px)}50%{transform:translateX(2px)}75%{transform:translateX(-1px)}}

/* Suitcase (RETRO AESTHETIC - LIGHT & AIRY) */
.suitcase-wrap{ position:relative; padding-top:4px; z-index:1; flex-shrink: 0; }
.suitcase{
  position:relative; min-height:300px; margin-top:6px;
  /* Light Vintage Blue Body */
  background: #CCEEFF; 
  border-radius:8px;
  /* Soft shadow and inner border */
  box-shadow: 0 4px 0 #A0CCFF, inset 0 0 0 3px #EBF4FF; 
  padding:26px 20px 30px; border: 4px solid #99BBCC; /* Muted darker border */
  overflow:visible;
}
.suitcase:before{ /* Handle */
  content:"";position:absolute;top:-16px;left:50%;transform:translateX(-50%);width:170px;height:20px;
  background:#b49b71; /* Vintage Tan */
  border:4px solid #967954; /* Darker Tan */
  border-bottom:none;
  border-radius:8px 8px 0 0;z-index:1;
}
.suitcase:after{content:"";position:absolute;left:22px;right:22px;bottom:-14px;height:14px;background:
  /* Simplified feet */
  radial-gradient(circle at 22px 7px,#000 0 6px,transparent 6px),
  radial-gradient(circle at calc(100% - 22px) 7px,#000 0 6px,transparent 6px);}
.corner{position:absolute;width:18px;height:18px;
  background:#FFD700; /* Softer Gold */
  border:2px solid #CCAD00;
  border-radius:4px;z-index:1;}
.corner.tl{top:8px;left:8px;} .corner.tr{top:8px;right:8px;} .corner.bl{bottom:8px;left:8px;} .corner.br{bottom:8px;right:8px;}
.strap{position:absolute;top:62px;bottom:28px;width:20px;
  background:#b49b71; /* Vintage Tan */
  border:2px solid #967954;
  border-radius:10px;z-index:1;}
.strap.left{left:52px;} .strap.right{right:52px;}
.buckle{position:absolute;width:34px;height:22px;
  background:#D4AF37; /* Gold/metal color */
  border:2px solid #9A7A00;
  border-radius:6px;top:100px;z-index:2;}
.buckle.left{left:34px;} .buckle.right{right:34px;}
.suitcase.drop-hover{outline:3px dashed var(--bkash);}
.packed{position:relative;z-index:3;display:flex;flex-wrap:wrap;gap:10px;padding-top:68px;}
.pill{display:inline-flex;align-items:center;gap:8px;background:#fff;border-radius:999px;padding:8px 12px;font-weight:800;border:2px solid #e5e7eb;box-shadow:0 2px 0 rgba(0,0,0,.04);}
.pill.good{background:#ecfdf5;color:#065f46;border-color:#a7f3d0;}
.pill.bad{background:#fef2f2;color:#7f1d1d;border-color:#fecaca;}
.pill svg{width:24px;height:24px;}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:80;}
.modal.active{display:flex;}
.modal .dialog{position:relative;background:#fff;width:min(760px,96%);border-radius:18px;box-shadow:var(--shadow);padding:16px;max-height:90vh;overflow:auto;}
.center{text-align:center;}
.brief-grid{display:grid;grid-template-columns:repeat(5, minmax(0,1fr));gap:8px;margin-top:10px;}
.brief-card{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;border:2px solid #f3e0ea;background:#fff;border-radius:14px;padding:10px;box-shadow:0 4px 0 #ffe4f2;}
.fin-scene{position:absolute;inset:0;opacity:.14;pointer-events:none;filter:saturate(1.1) contrast(1.05);}
.fin-scene .scene{height:100%;border:none;border-radius:0;}

/* Leaderboard Table */
.leader table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;box-shadow:var(--shadow);background:#fff;}
.leader th,.leader td{text-align:left;padding:10px 12px;border-bottom:1px solid #eee;font-size:.95rem;}
.leader th{background:#f9fafb; font-weight:800; color:#374151;}
.leader tbody tr:nth-child(1) td:first-child:before{content:"ü•á ";}
.leader tbody tr:nth-child(2) td:first-child:before{content:"ü•à ";}
.leader tbody tr:nth-child(3) td:first-child:before{content:"ü•â ";}

/* --- VERTICAL PLAYER OPTIMIZATION --- */
.grid.cols-2 { display: flex; flex-direction: column; height: 100%; gap: 12px; }

@media (orientation: portrait) {
    /* INTRO VIEW - allow scrolling on the card if the screen is too short */
    #view-intro .card { height: 100%; display: flex; flex-direction: column; overflow-y: auto; }
    #view-intro .grid.cols-2 > div:first-child { flex: 1; display: flex; flex-direction: column; }
    #view-intro .grid.cols-2 > div:nth-child(2) { flex: 0 0 auto; }

    /* GAME VIEW - allow scrolling on the main game card if the screen is too short */
    #view-game .card { display: flex; flex-direction: column; overflow-y: auto; }
    #view-game .grid.cols-2 > div:first-child { flex: 1; order: 1; display: flex; flex-direction: column; height: 100%; }
    #view-game .grid.cols-2 > div:nth-child(2) { flex: 0 0 auto; order: 2; }
    #view-game .board { display: flex; flex-direction: column; flex: 1; gap: 10px; }
    #view-game .board > div:first-child { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    #itemsGrid { flex: 1; overflow-y: auto; }
    .suitcase-wrap { flex: 0 0 auto; }
    .suitcase { min-height: 280px; }
}
</style>
</head>
<body>

<canvas id="confetti" class="confetti" style="position:fixed;inset:0;pointer-events:none; z-index:5;"></canvas>

<section id="view-landing" class="view">
  <button id="fullscreenToggle" class="fullscreen-toggle">‚õ∂</button>
  <button id="playButton">PLAY</button>

  <div class="landing-actions" id="leaderboardWrap">
    <button id="btnShowLeaderboard">üèÜ Leaderboard</button>
  </div>

  <div class="container" style="display: none;"></div>
</section>

<div id="leaderboardModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="lbTitle">
  <div class="dialog">
    <h3 id="lbTitle" style="margin-top:0; text-align:center;">üèÜ Fastest Packers üèÜ</h3>
    <div id="leaderboardContent" class="leader" style="max-height:60vh; overflow-y:auto;"></div>
    <div class="controls" style="justify-content:flex-end; margin-top:10px;">
        <button id="closeLeaderboard">Close</button>
    </div>
  </div>
</div>

<div id="nameModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="nameTitle">
  <div class="dialog">
    <h3 id="nameTitle" style="margin-top:0">Ready to Pack?</h3>
    <label for="modalPlayerName"><strong>Your Name</strong></label>
    <input id="modalPlayerName" type="text" maxlength="24" placeholder="Enter your name"/>
    <div class="controls" style="justify-content:flex-end; margin-top:10px; gap:10px;">
      <button id="cancelNameInput" class="btn-ghost">Cancel</button>
      <button id="startNameInput">Start Packing</button>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="dialog">
    <h3 id="settingsTitle" style="margin-top:0">‚öôÔ∏è Secret Settings</h3>
    <p class="help">Admin and data management panel. **Use with caution**.</p>
    
    <div style="margin-top:14px; padding-top:10px; border-top:1px solid var(--input-border);">
      <h4>Game Difficulty</h4>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>Items to Pack (Including Wallet):</strong>
            <div style="display:flex; align-items:center; gap:8px;">
              <input type="number" id="itemsToPackInput" min="5" max="7" value="5" style="width:80px; padding:8px; font-size:0.95rem;"/>
              <span class="help">(5-7)</span>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Max Wrong Picks:</strong>
          <div style="display:flex; align-items:center; gap:8px;">
            <input type="number" id="maxWrongPicks" min="1" max="20" value="4" style="width:80px; padding:8px; font-size:0.95rem;"/>
            <span class="help">(1-20)</span>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px; padding-top:10px; border-top:1px solid var(--input-border);">
      <h4>Data & Reset</h4>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Winners Leaderboard:</strong>
          <button id="resetLeaderboard" class="btn-plain" style="background:#ef4444; color:#fff;">Reset All Data</button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Game Stats (Daily):</strong>
          <button id="downloadDailyStats" class="btn-plain">Download Daily Stats (XLSX)</button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Game Stats (Lifetime):</strong>
          <button id="downloadStats" class="btn-plain">Download Lifetime Stats (XLSX)</button>
        </div>
      </div>
    </div>

    <div style="margin-top:14px; padding-top:10px; border-top:1px solid var(--input-border);">
      <h4>UI & Access</h4>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Landing Leaderboard Button:</strong>
          <div class="toggle" role="tablist" aria-label="Leaderboard Visibility">
            <button id="toggleLBShow" role="tab" class="active" aria-selected="true">Show</button>
            <button id="toggleLBHide" role="tab" aria-selected="false">Hide</button>
          </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Idle Timeout (5 mins):</strong>
          <div class="toggle" role="tablist" aria-label="Idle Timeout">
            <button id="toggleIdleOn" role="tab" class="active" aria-selected="true">On</button>
            <button id="toggleIdleOff" role="tab" aria-selected="false">Off</button>
          </div>
        </div>
        <div>
          <label for="secretCodeInput"><strong>Change Secret Code</strong></label>
          <input id="secretCodeInput" type="text" maxlength="12" placeholder="New Secret Code"/>
          <button id="changeSecretCode" style="margin-top:6px; width:100%;" class="btn-ghost">Save New Code</button>
          <div class="help" style="margin-top:4px;">Current Code: <strong id="currentSecretCode"></strong></div>
        </div>
      </div>
    </div>

    <div class="controls" style="justify-content:flex-end; margin-top:14px">
      <button id="closeSettings">Save & Close</button>
    </div>
  </div>
</div>

<div class="container main-game-content" style="display:none; position:relative; z-index:20;">
  <header id="gameHeader">
    <div class="brand">
      <div class="kite"></div>
      <div class="title">Pack & Go</div>
    </div>
    <div class="controls">
      <button class="btn-ghost" id="btnHomeHeader" style="display:none;">üè† Home</button> <button class="btn-plain" id="btnHow">How to Play</button>
      <button class="btn-ghost" id="btnReset">Reset</button>
    </div>
  </header>

  <section id="view-intro" class="view" style="display:none">
    <div class="card" style="height:100%">
      <div class="grid cols-2">
        <div style="display:flex; flex-direction:column;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h2 style="margin:0">Pick your vibe & get packing! ‚úàÔ∏è</h2>
            </div>
          <label for="playerName"><strong>Name</strong></label>
          <input id="playerName" maxlength="24" disabled style="background:#f3f4f6; color:#111827;"/>
          <div class="modebar">
            <span class="help">Mode</span>
            <div class="toggle" role="tablist" aria-label="Game Mode">
              <button id="modeTimer" class="active" role="tab" aria-selected="true">Timer</button>
            </div>
            <div id="timerBox" style="display:inline-flex;align-items:center;gap:8px">
              <span class="help">Seconds</span>
              <input type="number" id="timerSeconds" min="5" max="600" step="5" value="20"/>
            </div>
          </div>
          <div class="help" style="margin-top:8px">Destination</div>
          <div class="destinations-wrap">
            <div class="destinations" id="destList"></div>
          </div>
        </div>
        <div class="card">
          <div class="help">Pack all must-have items before time runs out!</div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-game" class="view" style="display:none">
    <div class="grid cols-2">
      <div class="card" style="display:flex; flex-direction:column; height: 100%;">
        <div class="controls" style="justify-content:space-between; margin-bottom:8px; align-items:flex-end">
          <div class="stats">
            <div class="stat"><small>Timer</small><span id="timer">00:00</span></div>
            <div class="stat"><small>Packed</small><span id="packedCount">0</span>/<span id="needCount">5</span></div>
          </div>
          <div class="controls">
            <button id="shuffleBtn" class="btn-plain">Shuffle</button>
          </div>
        </div>
        <div class="board">
          <div>
            <h3 style="margin:6px 0; color:#0f172a; position:relative; z-index:3">Drag & Drop Items</h3>
            <div id="itemsGrid" class="items" aria-live="polite"></div>
          </div>
          <div class="suitcase-wrap">
            <h3 style="margin:0 0 10px; color:#0f172a; position:relative; z-index:3">Your Suitcase</h3>
            <div id="suitcase" class="suitcase" aria-live="polite">
              <span class="corner tl"></span><span class="corner tr"></span><span class="corner bl"></span><span class="corner br"></span>
              <span class="strap left"></span><span class="strap right"></span>
              <span class="buckle left"></span><span class="buckle right"></span>
              <div id="packed" class="packed"></div>
            </div>
            <div class="help">Tip: Click items to pack. Click pills to remove. Drag-and-drop works too.</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:2px">Trip</h3>
        <div id="tripMeta" class="help"></div>
      </div>
    </div>
  </section>

  <div id="howModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="howTitle">
    <div class="dialog">
      <h3 id="howTitle" style="margin-top:0">How to Play</h3>
      <div id="howBody"></div>
      <div class="controls" style="justify-content:flex-end"><button id="closeHow">Got it</button></div>
    </div>
  </div>

  <div id="briefModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="briefTitle">
    <div class="dialog">
      <h3 id="briefTitle" style="margin-top:0">Trip Briefing</h3>
      <div id="briefBody" class="help"></div>
      <div id="briefGrid" class="brief-grid" aria-live="polite"></div>
      <div id="briefNote" class="help" style="margin-top:8px"></div>
      <div class="controls" style="justify-content:space-between; margin-top:10px">
        <button id="briefCancel" class="btn-plain">Cancel</button>
        <button id="briefStart">Let‚Äôs Pack</button>
      </div>
    </div>
  </div>

  <div id="finishModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="finTitle">
    <div class="dialog">
      <div id="finScene" class="fin-scene"></div>
      <h2 id="finTitle" style="margin:.2rem 0; position:relative; z-index:2"><span id="finLead">Well done!</span> üß≥</h2>
      <div id="finGrid" class="grid" style="grid-template-columns:1fr; gap:10px; position:relative; z-index:2">
        <div class="card center"><div class="stat"><small>Time</small><span id="finTime">00:00.000</span></div></div>
      </div>
      <div class="card" style="margin-top:8px; position:relative; z-index:2">
        <div class="help"><strong>Destination:</strong> <span id="finDest">‚Äî</span></div>
        <div id="finBoardEntry" class="help" style="margin-top:6px; display:none; color:#16a34a; font-weight:700;">
          üéâ You made it onto the Leaderboard!
        </div>
      </div>
      <div class="controls" style="justify-content:space-between; margin-top:10px; position:relative; z-index:2">
        <button id="playAgain" class="btn-ghost">Play Again</button>
        <div>
          <button id="continueBanner" class="btn-soft">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <div id="bannerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bannerTitle">
    <div class="dialog center">
      <h3 id="bannerTitle" style="margin:0 0 6px"> </h3>
      <img id="bannerImg" alt="Campaign Banner" style="max-width:100%;height:auto;border-radius:14px;box-shadow:var(--shadow);"/>
      <div class="controls" style="justify-content:center; margin-top:10px; gap:10px">
        <button id="homeBtn" class="btn-ghost">Home</button>
      </div>
    </div>
  </div>
</div>

<script>
const el = s=>document.querySelector(s);
const showMainContent = (show) => {
    el('.main-game-content').style.display = show ? 'flex' : 'none'; 
    el('header').style.display = show ? 'flex' : 'none'; 
};

function goHome(){
  go('landing');
  el('#view-landing').style.display = 'block'; 
  el('#playButton').style.display = 'block'; 
  showMainContent(false);
  updateLeaderboardButtonVisibility();
}

function go(view){
  document.querySelectorAll('.view').forEach(v=>{ v.style.display='none'; });
  document.querySelectorAll('.modal').forEach(m=>{ m.classList.remove('active'); }); 
  
  const btnHome = el('#btnHomeHeader');
  const btnReset = el('#btnReset');

  if (view === 'landing') {
    el(`#view-landing`).style.display = 'block';
    el('#playButton').style.display = 'block';
    showMainContent(false);
  } else {
    el(`#view-${view}`).style.display = 'flex';
    el('#view-landing').style.display = 'none'; 
    el('#playButton').style.display = 'none'; 
    showMainContent(true);
    
    // Manage Home/Reset button visibility
    if (view === 'intro') {
        btnHome.style.display = 'block'; 
        btnReset.style.display = 'none'; 
    } else if (view === 'game') {
        btnHome.style.display = 'none';
        btnReset.style.display = 'block'; 
    }
  }
}

document.getElementById('playButton').addEventListener('click', function() {
    el('#modalPlayerName').value = state.playerName; 
    el('#nameModal').classList.add('active');
    el('#modalPlayerName').focus();
});

el('#startNameInput').addEventListener('click', processNameInput);
el('#modalPlayerName').addEventListener('keypress', e => {
    if (e.key === 'Enter') processNameInput();
});

function processNameInput() {
    const nameInput = el('#modalPlayerName').value.trim();
    if (!nameInput) {
        alert("Please enter your name!");
        return;
    }
    if (nameInput.toLowerCase() === state.secretCode.toLowerCase()) {
        openSettings();
    } else {
        state.playerName = nameInput;
        el('#playerName').value = nameInput; 
        el('#nameModal').classList.remove('active');
        go('intro');
    }
}

/* ===== Retro beep kit (Boosted Volume) - Unchanged ===== */
const AudioKit = (()=>{
  let ctx, unlocked=false;
  function ac(){ if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)(); return ctx; }
  function unlock(){ if(unlocked) return; const c=ac(), o=c.createOscillator(), g=c.createGain(); g.gain.value=0; o.connect(g).connect(c.destination); o.start(0); o.stop(c.currentTime+.01); unlocked=true; }
  document.addEventListener('pointerdown', unlock, {once:true,capture:true});
  
  // Base gain increased from 0.06 to 0.25 (approx 4x louder)
  function beep({freq=880, dur=0.08, type='square', gain=0.25}){
    const c=ac(), o=c.createOscillator(), g=c.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(c.destination);
    const t=c.currentTime; o.start(t); o.stop(t+dur);
  }
  function chord(a=[523,659,784], d=.12){ a.forEach((f,i)=> setTimeout(()=>beep({freq:f,dur:d,type:'triangle',gain:.2}), i*8)); }
  return {
    correct:()=>beep({freq:980,dur:.09,type:'square'}),
    wrong:()=>beep({freq:220,dur:.12,type:'sawtooth',gain:.35}), // Very loud error
    hint:()=>beep({freq:660,dur:.06,type:'triangle'}),
    finish:()=>chord(),
    click:()=>beep({freq:520,dur:.05,type:'square'}),
    timesup:()=>{ beep({freq:180,dur:.08,type:'sine',gain:.35}); setTimeout(()=>beep({freq:140,dur:.1,type:'sine',gain:.35}), 90); }
  };
})();

/* ===== Confetti (Unchanged) ===== */
(function(){
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; } resize(); addEventListener('resize', resize);
  const parts = [];
  const colorsWin = ['#E2136E','#ff9aca','#fff','#ffe08a'];
  const colorsLose = ['#9ca3af','#e5e7eb','#cbd5e1'];
  function emit(n=120, lose=false){
    const colors = lose? colorsLose : colorsWin;
    for(let i=0;i<n;i++){ parts.push({x:canvas.width/2,y:canvas.height/3, vx:(Math.random()-0.5)*6, vy:Math.random()*-5-2, g:0.12, r:2+Math.random()*3, c:colors[Math.floor(Math.random()*colors.length)], a:1}); }
  }
  function step(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const p of parts){
      p.vy+=p.g; p.x+=p.vx; p.y+=p.y; p.a-=0.006;
      ctx.globalAlpha = Math.max(p.a,0); ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    }
    for(let i=parts.length-1;i>=0;i--){ if(parts[i].a<=0 || parts[i].y>canvas.height+20) parts.splice(i,1); }
    requestAnimationFrame(step);
  }
  step();
  window.confettiBurst = ()=>emit(140,false);
  window.loseBurst = ()=>emit(90,true);
})();

/* ===== Scenes & Icons (Unchanged) ===== */
const Scenes = {
  beach: () => `<svg class="scene" viewBox="0 0 320 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="skyb" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#bfefff"/><stop offset="100%" stop-color="#eafcff"/></linearGradient><linearGradient id="sand" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#ffe3ad"/><stop offset="100%" stop-color="#ffd189"/></linearGradient></defs><rect width="320" height="120" fill="url(#skyb)"/><circle cx="260" cy="24" r="12" fill="#ffd56a" opacity=".9"/><path d="M0 86 Q80 80 160 86 T320 86 V120 H0 Z" fill="#a7e9ff" opacity=".7"/><path d="M0 92 Q80 86 160 92 T320 92 V120 H0 Z" fill="#93ddff" opacity=".9"/><path d="M0 102 Q80 98 160 102 T320 102 V120 H0 Z" fill="url(#sand)"/><g opacity=".9"><rect x="76" y="60" width="2" height="30" fill="#a16207"/><path d="M60 60 l20 -25 l20 25 z" fill="#f59e0b"/></g></svg>`,
  tea: () => `<svg class="scene" viewBox="0 0 320 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="skyt" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#d4ffe9"/><stop offset="100%" stop-color="#f0fffb"/></linearGradient></defs><rect width="320" height="120" fill="url(#skyt)"/><path d="M0 96 Q60 74 120 96 T240 96 T320 96 V120 H0 Z" fill="#86efac"/><path d="M-20 110 Q40 88 100 110 T220 110 T340 110 V120 H-20 Z" fill="#22c55e" opacity=".6"/><g stroke="#10b981" stroke-linecap="round"><line x1="36" y1="20" x2="46" y2="30"/><line x1="60" y1="22" x2="70" y2="32"/><line x1="84" y1="20" x2="94" y2="30"/></g></svg>`,
  hills: () => `<svg class="scene" viewBox="0 0 320 120" xmlns="http://www.w3.org/2000/svg"><rect width="320" height="120" fill="#eef2ff"/><path d="M0 110 L45 68 L85 96 L130 54 L175 84 L220 62 L260 90 L320 112 V120 H0 Z" fill="#a5b4fc"/><g fill="#6366f1" opacity=".9"><circle cx="42" cy="26" r="2"/><circle cx="62" cy="22" r="1.7"/><circle cx="84" cy="28" r="1.3"/></g></svg>`,
  haor: () => `<svg class="scene" viewBox="0 0 320 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="skyh" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#c7f3ff"/><stop offset="100%" stop-color="#eaffff"/></linearGradient></defs><rect width="320" height="120" fill="url(#skyh)"/><path d="M0 92 Q60 86 120 92 T240 92 T320 92 V120 H0 Z" fill="#b3eaff"/><g><path d="M120 90 l22 -10 28 10 z" fill="#7c3aed" opacity=".85"/><rect x="148" y="72" width="2" height="12" fill="#7c3aed"/><path d="M150 72 l10 6 l-10 6 z" fill="#E2136E" opacity=".9"/></g><g fill="#22c55e" opacity=".8"><circle cx="36" cy="106" r="3"/><circle cx="44" cy="104" r="2"/><circle cx="52" cy="106" r="3"/></g></svg>`
};

function iconWrap(path){ return `<svg class="icon" viewBox="0 0 64 64" width="52" height="52" xmlns="http://www.w3.org/2000/svg">${path}</svg>`; }
const ICONS = {
  wallet: iconWrap(`<rect x="14" y="8" rx="8" ry="8" width="36" height="48" fill="#E2136E" stroke="#B60F58" stroke-width="2"/><rect x="16" y="12" width="32" height="40" rx="6" ry="6" fill="#ff4fa0" opacity=".15"/><g><rect x="18" y="18" width="28" height="28" rx="4" fill="#E2136E"/><image href="assets/wallet-ui.png" x="19" y="19" width="26" height="26" preserveAspectRatio="xMidYMid slice"/></g>`),
  sunscreen: iconWrap(`<rect x="18" y="10" rx="6" ry="6" width="28" height="44" fill="#FFB020" stroke="#CC8A18" stroke-width="2"/><circle cx="32" cy="32" r="6" fill="#fff"/><path d="M22 18h20" stroke="#fff" stroke-width="3"/>`),
  sunglasses: iconWrap(`<rect x="10" y="26" width="18" height="12" rx="6" fill="#111"/><rect x="36" y="26" width="18" height="12" rx="6" fill="#111"/><rect x="28" y="28" width="8" height="4" fill="#444"/><path d="M10 26h18M36 26h18" stroke="#6b7280" stroke-width="3"/>`),
  shorts: iconWrap(`<path d="M12 14h40l-6 22H34l-2-4-2 4H18L12 14z" fill="#60A5FA" stroke="#2563EB" stroke-width="2"/>`),
  sandals: iconWrap(`<path d="M8 36c10-8 28-8 48 0v6H8v-6z" fill="#F59E0B" stroke="#B45309" stroke-width="2"/>`),
  raincoat: iconWrap(`<path d="M20 10h24l10 18v24H10V28l10-18z" fill="#34D399" stroke="#059669" stroke-width="2"/>`),
  umbrella: iconWrap(`<path d="M32 10a22 22 0 0122 32H10A22 22 0 0132 10z" fill="#60A5FA" stroke="#2563EB" stroke-width="2"/><path d="M32 32v16a6 6 0 0012 0" stroke="#1F2937" stroke-width="3"/>`),
  walkshoes: iconWrap(`<path d="M8 38l12-8 10 8 18 2v8H8v-10z" fill="#9CA3AF" stroke="#4B5563" stroke-width="2"/>`),
  repellent: iconWrap(`<rect x="22" y="12" width="20" height="40" rx="6" fill="#FCA5A5" stroke="#DC2626" stroke-width="2"/><rect x="26" y="18" width="12" height="14" fill="#fff"/><circle cx="32" cy="40" r="3" fill="#DC2626"/>`),
  camera: iconWrap(`<rect x="8" y="18" width="48" height="30" rx="6" fill="#111827"/><circle cx="32" cy="33" r="10" fill="#1F2937" stroke="#93C5FD" stroke-width="3"/><rect x="20" y="14" width="12" height="8" rx="3" fill="#6B7280"/>`),
  hikeboots: iconWrap(`<path d="M10 36h22l10 8h12v8H10v-16z" fill="#F59E0B" stroke="#B45309" stroke-width="2"/>`),
  backpack: iconWrap(`<rect x="16" y="12" width="32" height="40" rx="10" fill="#A78BFA" stroke="#7C3AED" stroke-width="2"/><rect x="20" y="24" width="24" height="14" rx="6" fill="#DDD6FE"/>`),
  jacket: iconWrap(`<path d="M20 10h24l10 18v26H10V28l10-18z" fill="#60A5FA" stroke="#2563EB" stroke-width="2"/>`),
  flashlight: iconWrap(`<path d="M18 10h28l-8 10v22l-12 12V20L18 10z" fill="#FCD34D" stroke="#F59E0B" stroke-width="2"/>`),
  firstaid: iconWrap(`<rect x="8" y="18" width="48" height="30" rx="8" fill="#FCA5A5" stroke="#DC2626" stroke-width="2"/><path d="M32 22v22M21 33h22" stroke="#fff" stroke-width="6"/>`),
  hat: iconWrap(`<ellipse cx="32" cy="44" rx="22" ry="8" fill="#FDE68A" stroke="#D97706" stroke-width="2"/><rect x="22" y="22" width="20" height="16" rx="6" fill="#F59E0B"/>`),
  towel: iconWrap(`<rect x="18" y="12" width="28" height="40" rx="6" fill="#93C5FD" stroke="#3B82F6" stroke-width="2"/><path d="M22 18h20M22 28h20M22 38h20" stroke="#fff" stroke-width="3"/>`),
  map: iconWrap(`<path d="M8 16l16-6 16 6 16-6v36l-16 6-16-6-16 6V16z" fill="#BBF7D0" stroke="#059669" stroke-width="2"/>`),
  powerbank: iconWrap(`<rect x="18" y="10" width="28" height="44" rx="10" fill="#E9D5FF" stroke="#7C3AED" stroke-width="2"/><path d="M32 18l-6 12h12l-6 12" stroke="#7C3AED" stroke-width="3"/>`),
  lifejacket: iconWrap(`<path d="M18 10h28l8 14v28H10V24l8-14z" fill="#fb923c" stroke="#ea580c" stroke-width="2"/><path d="M28 10v44M36 10v44" stroke="#fff" stroke-width="3" opacity=".8"/>`),
  drybag: iconWrap(`<path d="M18 14h28l4 8v30H14V22l4-8z" fill="#22d3ee" stroke="#0891b2" stroke-width="2"/><rect x="22" y="18" width="20" height="6" rx="2" fill="#0ea5e9"/>`),
  watershoes: iconWrap(`<path d="M8 40c10-8 22-8 40 0l8 2v8H8v-10z" fill="#38bdf8" stroke="#0369a1" stroke-width="2"/>`),
  water: iconWrap(`<rect x="24" y="10" width="16" height="30" rx="6" fill="#93c5fd" stroke="#3b82f6" stroke-width="2"/><rect x="26" y="12" width="12" height="8" rx="2" fill="#60a5fa"/><rect x="26" y="40" width="12" height="12" rx="3" fill="#1d4ed8"/><circle cx="32" cy="34" r="3" fill="#eff6ff"/>`)
};

const DESTINATIONS = [
  { id:'beach', name:'Beach ‚Äî Cox‚Äôs Bazar', blurb:'Sun, surf, and sandy toes. Pack light & sun-safe!', scene:Scenes.beach,
    pool:['sunscreen','sunglasses','shorts','sandals','towel','hat','water'] },
  { id:'tea', name:'Tea Estates ‚Äî Sylhet', blurb:'Lush greenery & drizzle. Think rain-ready & comfy.', scene:Scenes.tea,
    pool:['raincoat','umbrella','walkshoes','repellent','camera','water','hat'] },
  { id:'hills', name:'Hills ‚Äî Bandarban', blurb:'Trails & cool nights. Go sturdy & outdoorsy.', scene:Scenes.hills,
    pool:['hikeboots','backpack','jacket','flashlight','firstaid','map','powerbank','water'] },
  { id:'haor', name:'Haor ‚Äî Sunamganj', blurb:'Open waters & boat rides. Stay dry, stay safe.', scene:Scenes.haor,
    pool:['raincoat','lifejacket','drybag','watershoes','camera','water','hat'] }
];
const ALL_ITEMS = [
  {id:'wallet', label:'Wallet', icon:'wallet'},
  {id:'sunscreen', label:'Sunscreen', icon:'sunscreen'},
  {id:'sunglasses', label:'Sunglasses', icon:'sunglasses'},
  {id:'shorts', label:'Shorts', icon:'shorts'},
  {id:'sandals', label:'Sandals', icon:'sandals'},
  {id:'raincoat', label:'Raincoat', icon:'raincoat'},
  {id:'umbrella', label:'Umbrella', icon:'umbrella'},
  {id:'walkshoes', label:'Walking Shoes', icon:'walkshoes'},
  {id:'repellent', label:'Mosquito Cream', icon:'repellent'},
  {id:'camera', label:'Camera', icon:'camera'},
  {id:'hikeboots', label:'Hiking Boots', icon:'hikeboots'},
  {id:'backpack', label:'Backpack', icon:'backpack'},
  {id:'jacket', label:'Warm Jacket', icon:'jacket'},
  {id:'flashlight', label:'Flashlight', icon:'flashlight'},
  {id:'firstaid', label:'First Aid', icon:'firstaid'},
  {id:'hat', label:'Sun Hat', icon:'hat'},
  {id:'towel', label:'Beach Towel', icon:'towel'},
  {id:'map', label:'Map', icon:'map'},
  {id:'powerbank', label:'Power Bank', icon:'powerbank'},
  {id:'lifejacket', label:'Life Jacket', icon:'lifejacket'},
  {id:'drybag', label:'Dry Bag', icon:'drybag'},
  {id:'watershoes', label:'Water Shoes', icon:'watershoes'},
  {id:'water', label:'Water Bottle', icon:'water'}
];

/* Keys */
const WINNERS_KEY        = 'packngo.winners.v7r7';
const STATS_KEY          = 'packngo.stats.v7r7';
const SECRET_CODE_KEY    = 'packngo.secret.code';
const LB_VISIBILITY_KEY  = 'packngo.lb.visible';
const HIDE_LEADERBOARD_KEY = 'packngo.hide.leaderboard';
const IDLE_TIMEOUT_KEY   = 'packngo.idle.timeout';
const MAX_WRONG_PICKS_KEY = 'packngo.max.wrong.picks';
const ITEMS_TO_PACK_KEY  = 'packngo.items.to.pack';

/* Millisecond Time Formatter (Added optional argument to hide milliseconds) */
const fmtTime = (ms, showMs=true)=>{ 
    const sec=Math.floor(ms/1000); 
    const m=Math.floor(sec/60); 
    const s=sec%60; 
    const base = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if (!showMs) return base;
    const mil=ms%1000;
    return `${base}.${String(mil).padStart(3,'0')}`; 
};

const shuffle = arr => arr.sort(()=>Math.random()-.5);
const escapeHtml = s => s.replace(/[&<>\"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

const state = { 
    mode:'timer', timerSec:20, playerName:'', dest:null, score:0, startTime:0, timerInt:null, packed:new Set(), wrongs:0, streak:0, needed:new Set(), currentSet:[],
    secretCode: localStorage.getItem(SECRET_CODE_KEY) || 'setting',
    hideLeaderboardButton: localStorage.getItem(HIDE_LEADERBOARD_KEY) === 'true',
    idleTimeoutEnabled: localStorage.getItem(IDLE_TIMEOUT_KEY) !== 'false',
    maxWrongPicks: parseInt(localStorage.getItem(MAX_WRONG_PICKS_KEY)) || 4,
    itemsToPack: parseInt(localStorage.getItem(ITEMS_TO_PACK_KEY)) || 5,
    idleTimer: null
};

/* --- LEADERBOARD & STATS --- */
function updateLeaderboardButtonVisibility() {
    const wrap = el('#leaderboardWrap');
    if (state.hideLeaderboardButton) wrap.style.display = 'none';
    else wrap.style.display = 'flex';
}

function loadWinners(){
    return JSON.parse(localStorage.getItem(WINNERS_KEY) || '[]')
        .sort((a,b)=> a.timeMs - b.timeMs) 
        .slice(0, 100); 
}
function saveWinners(list){ localStorage.setItem(WINNERS_KEY, JSON.stringify(list)); }
function addToWinners(entry){
    const list = loadWinners();
    if (entry.success && entry.timeMs <= (entry.timerSec * 1000) && entry.wrongs < state.maxWrongPicks) {
        entry.timestamp = new Date().toISOString();
        list.push(entry);
        saveWinners(list);
        return true; 
    }
    return false;
}

// Open Leaderboard Modal - Uses fmtTime with milliseconds (default)
el('#btnShowLeaderboard').addEventListener('click', ()=>{
    const list = loadWinners();
    const content = el('#leaderboardContent');
    if(list.length === 0){
        content.innerHTML = '<p class="help" style="text-align:center;">No winners yet. Be the first!</p>';
    } else {
        content.innerHTML = `<table><thead><tr><th>Rank</th><th>Name</th><th>Time</th><th>Dest</th></tr></thead><tbody>
        ${list.map((e, i) => `<tr><td>${i+1}</td><td>${escapeHtml(e.name)}</td><td>${fmtTime(e.timeMs)}</td><td>${DESTINATIONS.find(d=>d.id===e.dest)?.name.split('‚Äî')[0].trim() || 'N/A'}</td></tr>`).join('')}
        </tbody></table>`;
    }
    el('#leaderboardModal').classList.add('active');
});
el('#closeLeaderboard').addEventListener('click', ()=> el('#leaderboardModal').classList.remove('active'));


/* --- SETTINGS --- */
function openSettings(){
    el('#currentSecretCode').textContent = state.secretCode;
    
    // UI Updates
    if(state.hideLeaderboardButton){ el('#toggleLBHide').classList.add('active'); el('#toggleLBShow').classList.remove('active'); } 
    else { el('#toggleLBShow').classList.add('active'); el('#toggleLBHide').classList.remove('active'); }
    
    if(state.idleTimeoutEnabled){ el('#toggleIdleOn').classList.add('active'); el('#toggleIdleOff').classList.remove('active'); } 
    else { el('#toggleIdleOff').classList.add('active'); el('#toggleIdleOn').classList.remove('active'); }
    
    el('#maxWrongPicks').value = state.maxWrongPicks;
    el('#itemsToPackInput').value = state.itemsToPack;
    
    el('#settingsModal').classList.add('active');
}

el('#closeSettings').addEventListener('click', ()=> {
    // Save Max Wrongs
    const maxWrongValue = parseInt(el('#maxWrongPicks').value);
    if (maxWrongValue >= 1 && maxWrongValue <= 20) {
        state.maxWrongPicks = maxWrongValue;
        localStorage.setItem(MAX_WRONG_PICKS_KEY, maxWrongValue);
    }
    
    // Save Items to Pack
    const itemsVal = parseInt(el('#itemsToPackInput').value);
    if (itemsVal >= 5 && itemsVal <= 7) {
        state.itemsToPack = itemsVal;
        localStorage.setItem(ITEMS_TO_PACK_KEY, itemsVal);
    } else {
        alert('Items to pack must be between 5 and 7');
    }
    
    el('#settingsModal').classList.remove('active');
    goHome(); 
});

el('#resetLeaderboard').addEventListener('click', ()=>{
    if(confirm("Reset ALL Data? Undoing not possible.")){
        localStorage.removeItem(WINNERS_KEY); localStorage.removeItem(STATS_KEY);
        alert("Reset complete.");
    }
});

/* Toggle Handlers */
el('#toggleLBShow').addEventListener('click', ()=>{ state.hideLeaderboardButton = false; localStorage.setItem(HIDE_LEADERBOARD_KEY, 'false'); el('#toggleLBShow').classList.add('active'); el('#toggleLBHide').classList.remove('active'); });
el('#toggleLBHide').addEventListener('click', ()=>{ state.hideLeaderboardButton = true; localStorage.setItem(HIDE_LEADERBOARD_KEY, 'true'); el('#toggleLBHide').classList.add('active'); el('#toggleLBShow').classList.remove('active'); });

/* Data Downloads */
function downloadStatsData(){
    const winners = loadWinners();
    let csv = "data:text/csv;charset=utf-8,Rank,Name,Time,Timestamp\n";
    winners.forEach((e,i)=> csv += `${i+1},"${e.name}",${fmtTime(e.timeMs)},${e.timestamp}\n`);
    const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "stats.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
el('#downloadStats').addEventListener('click', downloadStatsData);


/* --- GAMEPLAY --- */
function renderDestCards(){
  const wrap = el('#destList');
  wrap.innerHTML = DESTINATIONS.map(d=>`
    <div class="dest-card" data-dest="${d.id}" tabindex="0" role="button">
      <div class="scene-wrap">${d.scene()}</div>
      <div class="grow"><h3>${d.name}</h3><p>${d.blurb}</p></div>
      <div class="footer"><span class="chip">Select</span></div>
    </div>`).join('');
  wrap.querySelectorAll('.dest-card').forEach(card=>{
    card.addEventListener('click', (e)=> { e.stopPropagation(); selectDestination(card.dataset.dest); }, true);
  });
}

function selectDestination(id){
  state.dest = id;
  const d = DESTINATIONS.find(x=>x.id===id);
  
  // DYNAMIC ITEM COUNT LOGIC
  const totalNeeded = state.itemsToPack; 
  const randomCount = totalNeeded - 1; // 1 is always wallet
  
  const pick = shuffle([...d.pool]).slice(0, randomCount);
  state.currentSet = ['wallet', ...pick];
  state.needed = new Set(state.currentSet);

  el('#briefBody').innerHTML = `<div class="help"><strong>${d.name}</strong></div><div>Must-haves:</div>`;
  el('#briefGrid').innerHTML = state.currentSet.map(it=>{
    const meta=ALL_ITEMS.find(x=>x.id===it);
    return `<div class="brief-card">${ICONS[meta.icon]}<div class="label">${meta.label}</div></div>`;
  }).join('');
  
  el('#briefNote').innerHTML = `<div class="note">Pack these <strong>${totalNeeded} items</strong> within <strong>${state.timerSec}s</strong>!</div>`;
  el('#briefModal').classList.add('active');
}

function renderItems(){
  const pool = new Set(DESTINATIONS.find(d=>d.id===state.dest).pool);
  const required = [...state.needed];
  // Calculate distractors to ensure grid is full (approx 15 items total usually)
  const distractorsNeeded = Math.max(0, 15 - required.length);
  const distractors = shuffle(ALL_ITEMS.filter(x=> x.id!=='wallet' && !pool.has(x.id))).slice(0, distractorsNeeded).map(x=>x.id);
  const options = shuffle([...new Set([...required, ...distractors])]).map(id=>ALL_ITEMS.find(x=>x.id===id));
  
  const grid = el('#itemsGrid'); grid.innerHTML=''; 
  options.forEach(it=>{
      const div=document.createElement('div'); div.className='item'; div.dataset.id=it.id;
      div.innerHTML = `<div class="icon">${ICONS[it.icon]||''}</div><div class="label">${it.label}</div>`;
      div.addEventListener('click', ()=>packItem(it.id));
      div.setAttribute('draggable','true');
      div.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', it.id); });
      grid.appendChild(div);
  });
}

function renderSuitcase(){
  const area = el('#packed'); 
  const pills = [...state.packed].map(id => {
      const it=ALL_ITEMS.find(x=>x.id===id);
      return `<span class="pill ${state.needed.has(id)?'good':'bad'}" data-id="${id}">${ICONS[it.icon]} ${it.label}</span>`;
  });
  area.innerHTML = pills.join('');
  area.querySelectorAll('.pill').forEach(p=> p.addEventListener('click', ()=> removePacked(p.dataset.id)));
}

function renderCounts(){ 
    const have = [...state.packed].filter(id=>state.needed.has(id)).length; 
    el('#packedCount').textContent = String(have); 
    el('#needCount').textContent = String(state.needed.size); // Will show 5, 6, or 7
}

function startGame(){
  const secVal = parseInt(el('#timerSeconds').value||'20');
  state.timerSec = (secVal >= 5 && secVal <= 600) ? secVal : 20;

  el('#briefModal').classList.remove('active');
  state.score = 0; state.packed.clear(); state.wrongs=0;
  state.startTime = Date.now();

  go('game');
  el('#tripMeta').textContent = `${state.playerName} ‚úàÔ∏è ${DESTINATIONS.find(x=>x.id===state.dest).name}`;
  renderItems(); renderSuitcase(); renderCounts();

  clearInterval(state.timerInt);
  state.timerInt = setInterval(()=>{
    const elapsed = Date.now() - state.startTime;
    // Pass false to hide milliseconds in gameplay
    el('#timer').textContent = fmtTime(elapsed, false); 
    if((elapsed/1000) >= state.timerSec){ clearInterval(state.timerInt); timeUp(); }
  }, 37); // Faster update for milliseconds
}

function packItem(id){
  if(state.packed.has(id)) return;
  state.packed.add(id);
  if(state.needed.has(id)){
    const node = document.querySelector(`[data-id="${CSS.escape(id)}"]`); 
    if(node) { node.classList.add('correct'); setTimeout(()=> node.classList.remove('correct'), 350); }
    AudioKit.correct();
  } else {
    state.wrongs++;
    const node = document.querySelector(`[data-id="${CSS.escape(id)}"]`); 
    if(node) { node.classList.add('wrong'); setTimeout(()=> node.classList.remove('wrong'), 350); }
    AudioKit.wrong();
    if(state.wrongs >= state.maxWrongPicks){ finishGame(false, false, true); return; }
  }
  renderSuitcase(); renderCounts();
  if([...state.packed].filter(id=>state.needed.has(id)).length === state.needed.size) finishGame(true);
}

function removePacked(id){ 
    if(!state.packed.has(id)) return; 
    state.packed.delete(id); renderSuitcase(); renderCounts(); 
}

function timeUp(){ finishGame(false, true); }

function finishGame(success=true, timedOut=false, wrongLimit=false){
  clearInterval(state.timerInt);
  const timeMs = Date.now() - state.startTime;
  
  const entry = { name: state.playerName, timeMs: timeMs, timerSec: state.timerSec, dest: state.dest, wrongs: state.wrongs, success: success && !timedOut && !wrongLimit };
  const added = addToWinners(entry);

  el('#finBoardEntry').style.display = added ? 'block' : 'none';
  el('#finLead').textContent = (timedOut || wrongLimit) ? "Time's up / Too many wrongs!" : "Boarding Successful!";
  
  const finDialog = el('#finishModal .dialog');
  if (timedOut || wrongLimit) {
      finDialog.style.border = "4px solid #ef4444"; 
      window.loseBurst && window.loseBurst(); 
      AudioKit.timesup();
  } else {
      finDialog.style.border = "4px solid #16a34a"; 
      window.confettiBurst && window.confettiBurst(); 
      AudioKit.finish();
  }

  // Use default fmtTime to show milliseconds on the finish screen
  el('#finTime').textContent = fmtTime(timeMs);
  el('#finDest').textContent = DESTINATIONS.find(d=>d.id===state.dest).name;
  el('#finScene').innerHTML = DESTINATIONS.find(d=>d.id===state.dest).scene();
  el('#finishModal').classList.add('active');
}

/* Drag & Drop */
const box = el('#suitcase');
['dragover','dragenter'].forEach(e=> box.addEventListener(e, ev=>{ ev.preventDefault(); box.classList.add('drop-hover'); }));
['dragleave','drop'].forEach(e=> box.addEventListener(e, ()=> box.classList.remove('drop-hover')));
box.addEventListener('drop', e=>{ e.preventDefault(); const id=e.dataTransfer.getData('text/plain'); if(id) packItem(id); });

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{
  renderDestCards();
  
  // NEW HOME BUTTON EVENT LISTENER
  el('#btnHomeHeader').addEventListener('click', goHome);
  
  el('#fullscreenToggle').addEventListener('click', ()=> {
      if(!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
  });
  el('#btnReset').addEventListener('click', ()=> go('intro'));
  el('#btnHow').addEventListener('click', ()=> el('#howModal').classList.add('active'));
  el('#closeHow').addEventListener('click', ()=> el('#howModal').classList.remove('active'));
  el('#briefStart').addEventListener('click', ()=>{ startGame(); AudioKit.click(); });
  el('#briefCancel').addEventListener('click', ()=> el('#briefModal').classList.remove('active'));
  el('#shuffleBtn').addEventListener('click', ()=>{ renderItems(); AudioKit.click(); });
  el('#playAgain').addEventListener('click', ()=>{ el('#finishModal').classList.remove('active'); go('intro'); });
  el('#continueBanner').addEventListener('click', ()=>{
      el('#finishModal').classList.remove('active');
      el('#bannerImg').src = "assets/tt_story.jpg"; el('#bannerModal').classList.add('active');
  });
  el('#homeBtn').addEventListener('click', ()=> { el('#bannerModal').classList.remove('active'); goHome(); });

  goHome();
});
</script>
</body>
</html>